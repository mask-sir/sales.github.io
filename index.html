<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Sales Dashboard</title>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            background-image: 
                radial-gradient(at 0% 0%, hsla(212, 40%, 95%, 1) 0px, transparent 50%),
                radial-gradient(at 95% 90%, hsla(300, 80%, 95%, 1) 0px, transparent 50%);
        }
        .glass-ui {
            background-color: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.25);
        }
        #sidebar {
            background-color: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-right: 1px solid rgba(255, 255, 255, 0.15);
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }
        #sidebar.show { transform: translateX(0); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        .nav-link.active {
            background: linear-gradient(to right, #ec4899, #8b5cf6);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 15px -5px rgb(0 0 0 / 0.2);
        }
        .nav-link.active svg { color: white; }
        .brand-gradient { background-image: linear-gradient(to right, #ec4899, #8b5cf6); }
        #loading-overlay { transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-50">
        <svg class="animate-spin h-8 w-8 text-pink-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loading-text" class="text-slate-600 font-semibold">Connecting to Database...</p>
    </div>
    
    <header class="glass-ui sticky top-0 z-20 p-4 flex items-center justify-between md:hidden">
        <button id="hamburger-btn" class="p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
        <h1 class="text-xl font-extrabold text-transparent bg-clip-text brand-gradient">Sales Pro</h1>
    </header>

    <div class="flex">
        <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden opacity-0"></div>
        <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 p-4 z-40 md:relative md:transform-none">
             <div class="p-4 text-center md:text-left hidden md:block"><h1 class="text-2xl font-extrabold text-transparent bg-clip-text brand-gradient">Sales Pro</h1></div>
            <nav id="main-nav" class="mt-8 flex flex-col space-y-2">
                <a href="#home" class="nav-link active flex items-center gap-3 p-3 rounded-lg text-slate-700 hover:bg-white/50 transition-colors duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span>Home</span>
                </a>
                 <a href="#log-sale" class="nav-link flex items-center gap-3 p-3 rounded-lg text-slate-700 hover:bg-white/50 transition-colors duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>Log Sale</span>
                </a>
                <a href="#stock" class="nav-link flex items-center gap-3 p-3 rounded-lg text-slate-700 hover:bg-white/50 transition-colors duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span>Stock Overview</span>
                </a>
                <a href="#products" class="nav-link flex items-center gap-3 p-3 rounded-lg text-slate-700 hover:bg-white/50 transition-colors duration-200">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    <span>Manage Products</span>
                </a>
                <a href="#sales-data" class="nav-link flex items-center gap-3 p-3 rounded-lg text-slate-700 hover:bg-white/50 transition-colors duration-200">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span>Sales Data</span>
                </a>
                 <a href="#report" class="nav-link flex items-center gap-3 p-3 rounded-lg text-slate-700 hover:bg-white/50 transition-colors duration-200">
                   <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    <span>Sales Report</span>
                </a>
            </nav>
        </aside>

        <main id="app" class="flex-1 p-4 sm:p-6 lg:p-8">
            <section id="page-home" class="page"></section>
            <section id="page-stock" class="page hidden"></section>
            <section id="page-products" class="page hidden"></section>
            <section id="page-log-sale" class="page hidden"></section>
            <section id="page-sales-data" class="page hidden"></section>
            <section id="page-report" class="page hidden"></section>
        </main>
    </div>

    <!-- Modals -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="modal glass-ui rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <p id="modal-message" class="text-lg mb-6 font-medium"></p>
            <button id="modal-close-btn" class="w-full brand-gradient text-white px-6 py-2 rounded-lg hover:opacity-90 font-semibold">OK</button>
        </div>
    </div>
     <div id="new-month-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="modal glass-ui rounded-lg shadow-xl p-6 w-full max-w-sm">
             <h3 class="text-lg font-bold mb-4">Start a New Month's Log</h3>
             <form id="new-month-form">
                 <input type="month" id="new-month-input" class="w-full px-4 py-2 border border-slate-300/50 bg-white/50 rounded-lg focus:ring-2 focus:ring-pink-500 mb-4" required>
                 <div class="flex justify-end gap-3">
                    <button type="button" id="new-month-cancel" class="px-4 py-2 border border-slate-300/50 rounded-lg text-slate-700 hover:bg-slate-100/50 font-semibold">Cancel</button>
                    <button type="submit" class="brand-gradient text-white px-6 py-2 rounded-lg hover:opacity-90 font-semibold">Create</button>
                 </div>
             </form>
        </div>
    </div>
    <div id="scanner-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50">
        <div class="modal glass-ui rounded-lg shadow-xl p-4 w-full max-w-md">
            <h3 class="text-lg font-bold mb-4 text-center">Scan Barcode</h3>
            <div id="reader" class="w-full rounded-lg overflow-hidden min-h-[250px] bg-slate-100"></div>
            <p id="scanner-status" class="text-center text-sm text-slate-500 mt-2">Initializing camera...</p>
            <button id="scanner-cancel-btn" class="mt-4 w-full bg-slate-200/50 text-slate-800 px-6 py-2 rounded-lg hover:bg-slate-300/50 font-semibold">Cancel</button>
        </div>
    </div>

    <a href="#log-sale" title="Log a New Sale" class="fixed bottom-6 right-6 z-30 w-16 h-16 flex items-center justify-center rounded-full brand-gradient text-white shadow-lg hover:shadow-xl hover:scale-110 transition-all duration-300">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
    </a>

<script type="module">
    // --- SUPABASE SETUP ---
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const SUPABASE_URL = "https://nzjixfasdoolnvaftqam.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56aml4ZmFzZG9vbG52YWZ0cWFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTAwNzksImV4cCI6MjA3MzU4NjA3OX0.OD_Q6D2GXAYAYKkm07b7T3SRsxQo1--5HMYpnQz1NcA";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- DOM References ---
    const hamburgerBtn = document.getElementById('hamburger-btn');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const allPages = document.querySelectorAll('.page');
    const mainNav = document.getElementById('main-nav');
    const messageModal = document.getElementById('message-modal');
    const messageText = document.getElementById('modal-message');
    const messageCloseBtn = document.getElementById('modal-close-btn');
    const newMonthModal = document.getElementById('new-month-modal');
    const newMonthForm = document.getElementById('new-month-form');
    const newMonthCancelBtn = document.getElementById('new-month-cancel');
    const scannerModal = document.getElementById('scanner-modal');
    const scannerCancelBtn = document.getElementById('scanner-cancel-btn');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');

    // --- App State ---
    let appState = {
        productDatabase: [],
        salesLedger: {},
        currentMonthView: '', 
    };
    let html5QrCode = null;

    // --- Sidebar Toggle Logic ---
    const toggleSidebar = () => {
        sidebar.classList.toggle('show');
        sidebarOverlay.classList.toggle('hidden');
        setTimeout(() => sidebarOverlay.classList.toggle('opacity-0'), 10);
    };

    hamburgerBtn.addEventListener('click', toggleSidebar);
    sidebarOverlay.addEventListener('click', toggleSidebar);
    
    mainNav.addEventListener('click', (e) => {
        if (e.target.closest('a') && window.innerWidth < 768) {
            toggleSidebar();
        }
    });

    // --- DYNAMIC PAGE TEMPLATES (HTML generation) ---
    const getPageTemplate = (pageId) => {
        const templates = {
            'home': `
                <h2 class="text-3xl font-bold text-slate-800 mb-2">Dashboard</h2>
                <p class="text-slate-500 mb-8">Live overview of your sales and stock.</p>
                <div class="glass-ui rounded-xl shadow-lg p-6 mb-8 text-center border border-slate-200/75">
                    <h3 class="font-semibold text-slate-500 text-lg">All-Time Sales Value</h3>
                    <p id="all-time-sales" class="text-5xl font-extrabold text-transparent bg-clip-text brand-gradient mt-2">₹0.00</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="glass-ui rounded-xl shadow-lg p-5 border border-slate-200/75"><h3 class="font-semibold text-slate-500">Sales (Month)</h3><p id="month-sales" class="text-2xl font-bold text-pink-600 mt-2">₹0.00</p></div>
                    <div class="glass-ui rounded-xl shadow-lg p-5 border border-slate-200/75"><h3 class="font-semibold text-slate-500">Incentives (Month)</h3><p id="month-incentives" class="text-2xl font-bold text-green-600 mt-2">₹0.00</p></div>
                    <div class="glass-ui rounded-xl shadow-lg p-5 border border-slate-200/75"><h3 class="font-semibold text-slate-500">Stock (MM)</h3><p id="total-stock-mm" class="text-2xl font-bold text-sky-600 mt-2">0</p></div>
                    <div class="glass-ui rounded-xl shadow-lg p-5 border border-slate-200/75"><h3 class="font-semibold text-slate-500">Stock (Max)</h3><p id="total-stock-max" class="text-2xl font-bold text-teal-600 mt-2">0</p></div>
                </div>
                 <div class="glass-ui rounded-xl shadow-lg p-6 border border-slate-200/75">
                    <h3 class="text-xl font-bold mb-4">Quick Actions</h3>
                     <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="quick-actions">
                         <a href="#log-sale" class="nav-card text-center p-6 bg-pink-50 text-pink-700 rounded-lg hover:bg-pink-100 transition-colors"><h4 class="text-lg font-bold">Log a Sale</h4></a>
                        <a href="#stock" class="nav-card text-center p-6 bg-sky-50 text-sky-700 rounded-lg hover:bg-sky-100 transition-colors"><h4 class="text-lg font-bold">Update Stock</h4></a>
                        <a href="#products" class="nav-card text-center p-6 bg-violet-50 text-violet-700 rounded-lg hover:bg-violet-100 transition-colors"><h4 class="text-lg font-bold">Add Product</h4></a>
                        <a href="#report" class="nav-card text-center p-6 bg-teal-50 text-teal-700 rounded-lg hover:bg-teal-100 transition-colors"><h4 class="text-lg font-bold">View Reports</h4></a>
                    </div>
                </div>`,
            'stock': `
                <div class="glass-ui rounded-xl shadow-lg"><div class="p-4 sm:p-6 border-b border-white/20"><h3 class="text-2xl font-bold text-slate-800">Stock Overview</h3></div>
                    <div class="overflow-x-auto"><table class="min-w-full">
                        <thead><tr>
                            <th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase">Model</th><th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase">MM Mobiles</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase">Max</th><th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase">Total</th>
                        </tr></thead><tbody id="stock-table-body" class="divide-y divide-slate-200/50"></tbody>
                    </table></div></div>`,
            'products': `
                <div class="glass-ui rounded-xl shadow-lg p-6 md:p-8">
                    <h3 class="text-2xl font-bold mb-6 border-b border-white/20 pb-4">Manage Products</h3>
                    <form id="product-form" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="md:col-span-2"><label class="block text-sm font-medium text-slate-600 mb-1">Barcode</label><div class="flex">
                            <input type="text" id="product-barcode" class="w-full p-2 bg-white/50 border-r-0 border border-white/30 rounded-l-lg" required>
                            <button type="button" id="product-scan-btn" class="bg-violet-600 text-white p-2 rounded-r-lg hover:bg-violet-700" title="Scan Barcode"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6.375 6.375c3.512-3.512 9.213-3.512 12.725 0c3.512 3.512 3.512 9.213 0 12.725c-3.512 3.512-9.213 3.512-12.725 0c-3.512-3.512-3.512-9.213 0-12.725z M12 1.5v21 M1.5 12h21"></path></svg></button>
                        </div></div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium text-slate-600 mb-1">Model Name</label><input type="text" id="product-model" class="w-full p-2 bg-white/50 border border-white/30 rounded-lg" required></div>
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">MRP (₹)</label><input type="number" id="product-mrp" class="w-full p-2 bg-white/50 border border-white/30 rounded-lg" required></div>
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">Incentive (₹)</label><input type="number" id="product-incentive" class="w-full p-2 bg-white/50 border border-white/30 rounded-lg" required value="0" min="0"></div>
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">Stock (MM)</label><input type="number" id="product-stock-mm" class="w-full p-2 bg-white/50 border border-white/30 rounded-lg" required value="0" min="0"></div>
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">Stock (Max)</label><input type="number" id="product-stock-max" class="w-full p-2 bg-white/50 border border-white/30 rounded-lg" required value="0" min="0"></div>
                        <div class="md:col-span-2 flex justify-end"><button type="submit" class="brand-gradient text-white px-6 py-2 rounded-lg font-semibold">Add Product</button></div>
                    </form>
                    <div class="overflow-x-auto"><table class="min-w-full"><thead><tr>
                        <th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase">Model</th><th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase">Incentive</th>
                        <th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase">MM</th><th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase">Max</th>
                        <th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase">Actions</th>
                    </tr></thead><tbody id="product-table-body"></tbody></table></div>
                </div>`,
             'log-sale': `
                <div class="glass-ui rounded-xl shadow-lg p-6 md:p-8">
                     <div class="flex justify-between items-center mb-6 border-b border-white/20 pb-4"><h3 class="text-2xl font-bold">Log a Sale</h3><div id="log-month-selector-container"></div></div>
                     <form id="sales-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div><label class="block text-sm font-medium text-slate-600 mb-1">Shop</label><select id="sale-shop" name="shop" class="w-full p-2 bg-white/50 border border-white/30 rounded-lg" required><option value="" disabled selected>Select Shop</option><option value="MM">MM Mobiles</option><option value="Max">Max</option></select></div>
                         <div><label class="block text-sm font-medium text-slate-600 mb-1">Barcode</label><div class="flex">
                            <input type="text" id="sale-barcode" name="barcode" class="w-full p-2 bg-white/50 border-r-0 border border-white/30 rounded-l-lg" placeholder="Enter or Scan">
                            <button type="button" id="sale-scan-btn" class="bg-violet-600 text-white p-2 hover:bg-violet-700" title="Scan Barcode"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6.375 6.375c3.512-3.512 9.213-3.512 12.725 0c3.512 3.512 3.512 9.213 0 12.725c-3.512 3.512-9.213 3.512-12.725 0c-3.512-3.512-3.512-9.213 0-12.725z M12 1.5v21 M1.5 12h21"></path></svg></button>
                            <button type="button" id="fetch-btn" class="bg-slate-700 text-white px-4 rounded-r-lg font-semibold text-sm">Fetch</button>
                         </div></div>
                         <div class="md:col-span-2"><label class="block text-sm font-medium text-slate-600 mb-1">Model</label><input type="text" id="sale-model" name="model" class="w-full p-2 border rounded-lg bg-slate-100/50" readonly></div>
                         <div><label class="block text-sm font-medium text-slate-600 mb-1">MRP (₹)</label><input type="number" id="sale-mrp" name="mrp" class="w-full p-2 border rounded-lg bg-slate-100/50" readonly></div>
                         <div><label class="block text-sm font-medium text-slate-600 mb-1">Date</label><input type="date" id="sale-date" name="date" class="w-full p-2 bg-white/50 border border-white/30 rounded-lg" required></div>
                         <div><label class="block text-sm font-medium text-slate-600 mb-1">Mode of Payment</label><select id="sale-mode" name="mode" class="w-full p-2 bg-white/50 border border-white/30 rounded-lg" required><option>CASH</option><option>BAJAJ</option><option>CARD</option><option>UPI</option></select></div>
                         <div><label class="block text-sm font-medium text-slate-600 mb-1">Customer Name</label><input type="text" id="sale-name" name="name" class="w-full p-2 bg-white/50 border border-white/30 rounded-lg"></div>
                         <div class="md:col-span-2 flex justify-end"><button type="submit" class="brand-gradient text-white px-6 py-2 rounded-lg font-semibold">Log This Sale</button></div>
                     </form>
                </div>`,
            'sales-data': `
                 <div class="glass-ui rounded-xl shadow-lg">
                    <div class="flex flex-wrap justify-between items-center p-4 sm:p-6 border-b border-white/20 gap-4">
                        <div id="data-month-selector-container"></div>
                        <button id="export-btn" class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 font-semibold flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>Export to XL</span></button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 p-4 sm:p-6 border-b border-white/20 gap-4">
                         <div><h4 class="text-sm font-semibold text-slate-500">Total Sales for Period</h4><p id="sales-period-total" class="text-2xl font-bold text-pink-600">₹0.00</p></div>
                         <div><h4 class="text-sm font-semibold text-slate-500">Total Incentives for Period</h4><p id="incentives-period-total" class="text-2xl font-bold text-green-600">₹0.00</p></div>
                    </div>
                    <div class="overflow-x-auto"><table class="min-w-full"><thead><tr>
                        <th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase">SL</th><th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase">Model</th>
                        <th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase">Date</th><th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase">MRP</th>
                        <th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase">Incentive</th><th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase">Shop</th>
                        <th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase">Actions</th>
                    </tr></thead><tbody id="sales-table-body" class="divide-y divide-slate-200/50"></tbody></table></div>
                </div>`,
            'report': `
                <div class="glass-ui rounded-xl shadow-lg p-6 md:p-8">
                    <div class="flex justify-between items-center mb-6 border-b border-white/20 pb-4"><h3 class="text-2xl font-bold text-slate-800">Sales Report</h3><div id="report-month-selector-container"></div></div>
                    <div id="report-content"></div>
                </div>`
        };
        return templates[pageId] || '';
    };

    // --- NAVIGATION ---
    const showPage = (pageId) => {
        const newPageId = pageId || 'home';
        allPages.forEach(p => p.classList.toggle('hidden', p.id !== `page-${newPageId}`));
        mainNav.querySelectorAll('.nav-link').forEach(link => link.classList.toggle('active', link.hash === `#${newPageId}`));
        
        const targetPage = document.getElementById(`page-${newPageId}`);
        targetPage.innerHTML = getPageTemplate(newPageId);

        switch(newPageId) {
            case 'home': renderHomePage(); break;
            case 'stock': renderStockPage(); break;
            case 'products': renderProductPage(); break;
            case 'log-sale': renderLogSalePage(); break;
            case 'sales-data': renderSalesDataPage(); break;
            case 'report': renderReportPage(); break;
        }
        window.scrollTo(0, 0);
    }
    
    // --- SUPABASE DATA HANDLING ---
    async function fetchInitialData() {
        loadingText.textContent = 'Fetching products...';
        const { data: products, error: productError } = await supabase.from('products').select('*').order('model');
        if (productError) {
            console.error('Error fetching products:', productError);
            showMessage('Could not fetch products from database.');
            return;
        }
        appState.productDatabase = products;

        loadingText.textContent = 'Fetching sales records...';
        const { data: sales, error: salesError } = await supabase.from('sales').select('*').order('date', { ascending: false });
        if (salesError) {
            console.error('Error fetching sales:', salesError);
            showMessage('Could not fetch sales from database.');
            return;
        }

        // Process sales into ledger
        appState.salesLedger = {};
        sales.forEach(sale => {
            const monthKey = sale.date.substring(0, 7); // YYYY-MM
            if (!appState.salesLedger[monthKey]) {
                const saleDate = new Date(sale.date);
                const monthName = new Date(saleDate.getFullYear(), saleDate.getMonth(), 1).toLocaleString('default', { month: 'long', year: 'numeric' });
                appState.salesLedger[monthKey] = { name: monthName, sales: [] };
            }
            appState.salesLedger[monthKey].sales.push(sale);
        });

        // Re-number SL for each month
        for(const monthKey in appState.salesLedger) {
            appState.salesLedger[monthKey].sales
                .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())
                .forEach((sale, index) => sale.sl = index + 1);
        }

        const monthKeys = Object.keys(appState.salesLedger);
        appState.currentMonthView = monthKeys.length > 0 ? monthKeys.sort().reverse()[0] : 'all-time';

        loadingOverlay.classList.add('opacity-0');
        setTimeout(() => loadingOverlay.classList.add('hidden'), 300);
    }

    // --- BARCODE SCANNER ---
    const playScanSound = () => {
        try {
            if (Tone.context.state !== 'running') Tone.context.resume();
            const synth = new Tone.Synth().toDestination();
            synth.triggerAttackRelease("C5", "8n");
        } catch(e) { console.error("Could not play sound:", e); }
    }

    const startScanner = (targetInputId) => {
        scannerModal.classList.remove('hidden');
        document.getElementById('scanner-status').textContent = 'Requesting camera...';
        
        const qrCodeSuccessCallback = (decodedText) => {
            playScanSound();
            stopScanner();
            document.getElementById(targetInputId).value = decodedText;
            showMessage(`Barcode scanned!`);
            if (targetInputId === 'sale-barcode') document.getElementById('fetch-btn').click();
        };
        
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 } }, qrCodeSuccessCallback)
            .catch(err => {
                document.getElementById('scanner-status').textContent = 'Camera error. Use a secure (https) connection.';
            });
    }

    const stopScanner = () => {
        if (html5QrCode?.isScanning) {
            html5QrCode.stop().catch(err => console.error("Scanner stop error:", err));
        }
        scannerModal.classList.add('hidden');
    }

    // --- RENDER FUNCTIONS ---
    const renderHomePage = () => {
        const allTimeSales = Object.values(appState.salesLedger).flatMap(m => m.sales).reduce((sum, s) => sum + s.mrp, 0);
        document.getElementById('all-time-sales').textContent = formatCurrency(allTimeSales);

        let monthKey = appState.currentMonthView === 'all-time' ? (Object.keys(appState.salesLedger).sort().reverse()[0] || null) : appState.currentMonthView;
        const monthSalesData = (monthKey && appState.salesLedger[monthKey]?.sales) || [];
        const monthSales = monthSalesData.reduce((sum, s) => sum + s.mrp, 0);
        const monthIncentives = monthSalesData.reduce((sum, s) => sum + (s.incentive || 0), 0);
        const stockMM = appState.productDatabase.reduce((sum, p) => sum + p.stock_mm, 0);
        const stockMax = appState.productDatabase.reduce((sum, p) => sum + p.stock_max, 0);
        
        document.getElementById('month-sales').textContent = formatCurrency(monthSales);
        document.getElementById('month-incentives').textContent = formatCurrency(monthIncentives);
        document.getElementById('total-stock-mm').textContent = stockMM;
        document.getElementById('total-stock-max').textContent = stockMax;
        
        document.getElementById('quick-actions').addEventListener('click', e => { if (e.target.closest('a')) window.location.hash = e.target.closest('a').hash; });
    }

    const renderStockPage = () => {
        const tableBody = document.getElementById('stock-table-body');
        tableBody.innerHTML = appState.productDatabase.length === 0 ? `<tr><td colspan="4" class="text-center p-6 text-slate-500">No products.</td></tr>` : 
            appState.productDatabase.map(p => `<tr>
                <td class="p-3 text-sm font-medium text-slate-700">${p.model}</td>
                <td class="p-3 text-sm"><div class="flex items-center gap-3">
                    <button class="stock-btn" data-barcode="${p.barcode}" data-shop="MM" data-action="decr">-</button>
                    <span class="font-bold text-lg w-8 text-center">${p.stock_mm}</span>
                    <button class="stock-btn" data-barcode="${p.barcode}" data-shop="MM" data-action="incr">+</button>
                </div></td>
                <td class="p-3 text-sm"><div class="flex items-center gap-3">
                    <button class="stock-btn" data-barcode="${p.barcode}" data-shop="Max" data-action="decr">-</button>
                    <span class="font-bold text-lg w-8 text-center">${p.stock_max}</span>
                    <button class="stock-btn" data-barcode="${p.barcode}" data-shop="Max" data-action="incr">+</button>
                </div></td>
                <td class="p-3 text-sm font-bold text-slate-600">${p.stock_mm + p.stock_max}</td></tr>`).join('');
        
        tableBody.querySelectorAll('.stock-btn').forEach(btn => {
            btn.classList.add('w-8', 'h-8', 'flex', 'items-center', 'justify-center', 'bg-slate-200/50', 'text-slate-700', 'rounded-full', 'font-bold', 'text-lg', 'hover:bg-slate-300/50', 'transition-colors');
            btn.addEventListener('click', handleStockUpdate);
        });
    }
    
    const renderProductPage = () => {
        const form = document.getElementById('product-form');
        const tableBody = document.getElementById('product-table-body');
        document.getElementById('product-scan-btn').addEventListener('click', () => startScanner('product-barcode'));

        tableBody.innerHTML = appState.productDatabase.map(p => `<tr>
            <td class="p-3 text-sm">${p.model}</td>
            <td class="p-3 text-sm font-semibold text-green-700">${formatCurrency(p.incentive)}</td>
            <td class="p-3 text-sm font-bold">${p.stock_mm}</td>
            <td class="p-3 text-sm font-bold">${p.stock_max}</td>
            <td class="p-3 text-sm"><button class="text-red-500 hover:underline" data-barcode="${p.barcode}">Delete</button></td></tr>`).join('');

        tableBody.querySelectorAll('button[data-barcode]').forEach(btn => btn.addEventListener('click', deleteProduct));
        form.addEventListener('submit', addProduct);
    }

    const renderLogSalePage = () => {
        renderMonthSelector('log-month-selector-container', true);
        const dateInput = document.getElementById('sale-date');
        const today = new Date();
        dateInput.value = today.toISOString().split('T')[0];
        document.getElementById('sale-scan-btn').addEventListener('click', () => startScanner('sale-barcode'));
        document.getElementById('fetch-btn').addEventListener('click', () => {
            const barcode = document.getElementById('sale-barcode').value;
            const product = appState.productDatabase.find(p => p.barcode === barcode);
            if (product) {
                document.getElementById('sale-model').value = product.model;
                document.getElementById('sale-mrp').value = product.mrp;
            } else { showMessage('Product not found.'); }
        });
        document.getElementById('sales-form').addEventListener('submit', addSale);
    }

    const renderSalesDataPage = () => {
        renderMonthSelector('data-month-selector-container', false);
        renderSalesTable();
        document.getElementById('export-btn').addEventListener('click', exportToExcel);
    }
    
    const renderReportPage = () => {
       renderMonthSelector('report-month-selector-container', true);
       renderSalesReport(appState.currentMonthView);
    }
    
    // --- CORE LOGIC & DATABASE INTERACTIONS ---
    async function handleStockUpdate(e) {
        const { barcode, shop, action } = e.currentTarget.dataset;
        const product = appState.productDatabase.find(p => p.barcode === barcode);
        if (!product) return;
        const stockField = shop === 'MM' ? 'stock_mm' : 'stock_max';
        const change = action === 'incr' ? 1 : -1;
        if (product[stockField] + change < 0) return;

        const { error } = await supabase.from('products').update({ [stockField]: product[stockField] + change }).eq('barcode', barcode);
        if (error) {
            showMessage('Failed to update stock in database.');
        } else {
            product[stockField] += change;
            renderStockPage();
        }
    }

    async function addProduct(e) {
        e.preventDefault();
        const newProduct = {
            barcode: document.getElementById('product-barcode').value,
            model: document.getElementById('product-model').value,
            mrp: parseInt(document.getElementById('product-mrp').value, 10) || 0,
            incentive: parseInt(document.getElementById('product-incentive').value, 10) || 0,
            stock_mm: parseInt(document.getElementById('product-stock-mm').value, 10) || 0,
            stock_max: parseInt(document.getElementById('product-stock-max').value, 10) || 0
        };
        const { data, error } = await supabase.from('products').insert([newProduct]).select();
        if (error) {
            showMessage('Failed to add product: ' + error.message);
        } else {
            appState.productDatabase.push(data[0]);
            appState.productDatabase.sort((a, b) => a.model.localeCompare(b.model));
            renderProductPage();
            e.target.reset();
        }
    }

    async function deleteProduct(e) {
        const barcode = e.target.dataset.barcode;
        if (!confirm(`Delete product with barcode ${barcode}?`)) return;

        const { error } = await supabase.from('products').delete().eq('barcode', barcode);
        if (error) {
            showMessage('Failed to delete product: ' + error.message);
        } else {
            appState.productDatabase = appState.productDatabase.filter(p => p.barcode !== barcode);
            renderProductPage();
        }
    }
    
    async function addSale(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const shop = formData.get('shop');
        const barcode = formData.get('barcode');
        const monthKey = document.getElementById('log-month-selector-container').querySelector('select').value;

        if (!shop || !barcode || !monthKey || !appState.salesLedger[monthKey]) { showMessage("Please fill all fields and select a month."); return; }

        const product = appState.productDatabase.find(p => p.barcode === barcode);
        if (!product) { showMessage(`Product not found.`); return; }
        
        const stockField = shop === 'MM' ? 'stock_mm' : 'stock_max';
        if (product[stockField] <= 0) { showMessage(`Out of stock for ${product.model} at ${shop}.`); return; }

        const newSale = {
            barcode, shop,
            model: formData.get('model'),
            date: formData.get('date'),
            mrp: parseInt(formData.get('mrp'), 10) || 0,
            incentive: product.incentive || 0,
            mode: formData.get('mode'),
            name: formData.get('name'),
        };

        const { error: saleError } = await supabase.from('sales').insert([newSale]);
        if (saleError) { showMessage('Failed to log sale: ' + saleError.message); return; }

        const { error: stockError } = await supabase.from('products').update({ [stockField]: product[stockField] - 1 }).eq('barcode', barcode);
        if (stockError) { showMessage('Sale logged, but failed to update stock.'); }

        await fetchInitialData(); // Re-fetch all data to ensure sync
        showMessage("Sale logged successfully!");
        form.reset();
        document.getElementById('sale-date').value = new Date().toISOString().split('T')[0];
    }

    async function deleteSale(e) {
        const saleId = e.target.dataset.id;
        const monthKey = e.target.dataset.month;
        if (!confirm('Delete this sale? Stock will be restored.')) return;
        
        const saleToDelete = appState.salesLedger[monthKey].sales.find(s => s.id == saleId);
        if (!saleToDelete) return;
        
        const { error: deleteError } = await supabase.from('sales').delete().eq('id', saleId);
        if (deleteError) { showMessage('Failed to delete sale: ' + deleteError.message); return; }

        const product = appState.productDatabase.find(p => p.barcode === saleToDelete.barcode);
        if (product) {
            const stockField = saleToDelete.shop === 'MM' ? 'stock_mm' : 'stock_max';
            const { error: stockError } = await supabase.from('products').update({ [stockField]: product[stockField] + 1 }).eq('barcode', saleToDelete.barcode);
            if (stockError) showMessage('Sale deleted, but failed to restore stock.');
        }

        await fetchInitialData();
        renderSalesTable();
    }

    // --- RENDER TABLES AND SELECTORS ---
    const renderMonthSelector = (containerId, monthsOnly) => {
        const container = document.getElementById(containerId);
        if(!container) return;
        const monthKeys = Object.keys(appState.salesLedger).sort().reverse();
        
        let options = `${!monthsOnly ? '<option value="all-time">All-Time Sales</option>' : ''}` +
            monthKeys.map(key => `<option value="${key}">${appState.salesLedger[key].name}</option>`).join('');

        if (monthKeys.length === 0 && monthsOnly) {
             container.innerHTML = `<button id="start-month-btn" class="brand-gradient text-white px-4 py-2 rounded-lg text-sm font-semibold">Start First Log</button>`;
             document.getElementById('start-month-btn').addEventListener('click', () => newMonthModal.classList.remove('hidden'));
             return;
        }

        container.innerHTML = `<select id="month-selector-${containerId}" class="bg-white/50 border border-white/30 rounded-lg px-3 py-2 text-sm font-semibold">${options}</select>
            <button id="add-month-btn" class="ml-2 bg-slate-700 text-white p-2 rounded-lg hover:bg-slate-800 text-sm" title="Add New Month">+</button>`;

        const selector = document.getElementById(`month-selector-${containerId}`);
        selector.value = appState.currentMonthView;
        selector.addEventListener('change', e => {
            appState.currentMonthView = e.target.value;
            const currentPageId = document.querySelector('.page:not(.hidden)').id.replace('page-', '');
            showPage(currentPageId);
        });
        document.getElementById('add-month-btn').addEventListener('click', () => newMonthModal.classList.remove('hidden'));
    }

    const renderSalesTable = () => {
        const tableBody = document.getElementById('sales-table-body');
        let salesToDisplay = [];
        const isAllTime = appState.currentMonthView === 'all-time';
        if (isAllTime) {
            salesToDisplay = Object.entries(appState.salesLedger).flatMap(([monthKey, monthData]) => monthData.sales.map(sale => ({...sale, monthKey})));
        } else if (appState.salesLedger[appState.currentMonthView]) {
            salesToDisplay = appState.salesLedger[appState.currentMonthView].sales.map(sale => ({...sale, monthKey: appState.currentMonthView}));
        }

        document.getElementById('sales-period-total').textContent = formatCurrency(salesToDisplay.reduce((sum, s) => sum + s.mrp, 0));
        document.getElementById('incentives-period-total').textContent = formatCurrency(salesToDisplay.reduce((sum, s) => sum + (s.incentive || 0), 0));

        tableBody.innerHTML = salesToDisplay.length === 0 ? `<tr><td colspan="9" class="text-center p-6 text-slate-500">No sales data.</td></tr>` : 
            salesToDisplay.sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime()).map((sale, index) => `
                <tr>
                    <td class="p-3 text-sm">${isAllTime ? index + 1 : sale.sl}</td><td class="p-3 text-sm font-medium">${sale.model}</td>
                    <td class="p-3 text-sm">${sale.date}</td><td class="p-3 text-sm font-semibold">${formatCurrency(sale.mrp)}</td>
                    <td class="p-3 text-sm font-semibold text-green-700">${formatCurrency(sale.incentive || 0)}</td>
                    <td class="p-3 text-sm">${sale.shop}</td>
                    <td class="p-3 text-sm"><button class="text-red-500 hover:underline" data-id="${sale.id}" data-month="${sale.monthKey}">Delete</button></td>
                </tr>`).join('');

        tableBody.querySelectorAll('button').forEach(btn => btn.addEventListener('click', deleteSale));
    }
    
    const renderSalesReport = (monthKey) => {
        const reportContent = document.getElementById('report-content');
        if (monthKey === 'all-time' || !appState.salesLedger[monthKey] || appState.salesLedger[monthKey].sales.length === 0) {
            reportContent.innerHTML = `<div class="text-center py-12 text-slate-500"><p class="font-semibold text-lg">No sales data.</p><p>Select a month to view its report.</p></div>`;
            return;
        }

        const sales = appState.salesLedger[monthKey].sales;
        const totalRevenue = sales.reduce((sum, s) => sum + s.mrp, 0);
        const totalIncentives = sales.reduce((sum, s) => sum + (s.incentive || 0), 0);
        const unitsSold = sales.length;
        const modelCounts = sales.reduce((acc, s) => { acc[s.model] = (acc[s.model] || 0) + 1; return acc; }, {});
        const bestSeller = Object.keys(modelCounts).reduce((a, b) => modelCounts[a] > modelCounts[b] ? a : b, 'N/A');
        
        reportContent.innerHTML = `
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="p-4 bg-white/40 rounded-lg"><h4 class="text-sm font-semibold text-slate-500">Total Revenue</h4><p class="text-2xl font-bold">${formatCurrency(totalRevenue)}</p></div>
                <div class="p-4 bg-white/40 rounded-lg"><h4 class="text-sm font-semibold text-slate-500">Total Incentives</h4><p class="text-2xl font-bold text-green-600">${formatCurrency(totalIncentives)}</p></div>
                <div class="p-4 bg-white/40 rounded-lg"><h4 class="text-sm font-semibold text-slate-500">Units Sold</h4><p class="text-2xl font-bold">${unitsSold}</p></div>
                <div class="p-4 bg-white/40 rounded-lg"><h4 class="text-sm font-semibold text-slate-500">Best Seller</h4><p class="text-lg font-bold truncate">${bestSeller}</p></div>
            </div>`;
    }

    const exportToExcel = () => {
        try {
            let salesToExport = [];
            let filename = 'sales_report.xlsx';
            
            if (appState.currentMonthView === 'all-time') {
                salesToExport = Object.values(appState.salesLedger).flatMap(month => month.sales);
                filename = `all_time_sales_${new Date().toISOString().split('T')[0]}.xlsx`;
            } else if (appState.salesLedger[appState.currentMonthView]) {
                salesToExport = appState.salesLedger[appState.currentMonthView].sales;
                filename = `sales_${appState.currentMonthView}.xlsx`;
            }
            if (salesToExport.length === 0) { showMessage("No data to export."); return; }

            const dataForSheet = salesToExport.map(s => ({
                'SL No.': s.sl, 'Model': s.model, 'Date': s.date, 'Shop': s.shop, 'MRP': s.mrp, 'Incentive': s.incentive || 0,
                'Payment Mode': s.mode, 'Customer Name': s.name, 'Barcode': s.barcode
            }));
            
            const ws = XLSX.utils.json_to_sheet(dataForSheet);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sales Data");
            XLSX.writeFile(wb, filename);
        } catch (error) {
            console.error("Export to Excel failed:", error);
            showMessage("Could not export to Excel.");
        }
    };

    // --- UTILITY FUNCTIONS ---
    const showMessage = (msg) => {
        messageText.textContent = msg;
        messageModal.classList.remove('hidden');
    }
    const formatCurrency = (amount) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount);

    // --- INITIALIZATION ---
    async function initializeApp() {
        await fetchInitialData();
        const initialPage = window.location.hash.substring(1) || 'home';
        showPage(initialPage);
        
        window.addEventListener('hashchange', () => showPage(window.location.hash.substring(1) || 'home'));
        messageCloseBtn.addEventListener('click', () => messageModal.classList.add('hidden'));
        scannerCancelBtn.addEventListener('click', () => stopScanner());
        newMonthForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const monthInput = document.getElementById('new-month-input').value;
            if (!monthInput) return;
            
            if (appState.salesLedger[monthInput]) { showMessage(`Log for this month already exists.`); return; }
            
            // This doesn't require a DB write, just a state update
            const [year, month] = monthInput.split('-');
            const monthName = new Date(year, month - 1, 1).toLocaleString('default', { month: 'long', year: 'numeric' });
            appState.salesLedger[monthInput] = { name: monthName, sales: [] };
            appState.currentMonthView = monthInput; 
            
            newMonthModal.classList.add('hidden');
            const currentPageId = document.querySelector('.page:not(.hidden)').id.replace('page-', '');
            showPage(currentPageId); 
        });
        newMonthCancelBtn.addEventListener('click', () => newMonthModal.classList.add('hidden'));
    }

    initializeApp();
</script>
</body>
</html>


